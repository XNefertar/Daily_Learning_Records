# TCP

本篇文章要点：

- TCP报文
- TCP状态
- TCP的一系列机制
- 滑动窗口
- 面向字节流

今天我们来谈一谈`TCP`，即`传输控制协议`（Transmission Control Protocol）。总体来说，它是一个具有可靠性，面向连接的、面向字节流的一个__传输层协议__，传输层还有另一个协议——`UDP协议`，这个我们下一篇文章再详谈。



## TCP报文

我们先来看看`TCP协议`的报文部分，其包含了控制书籍传输的多个字段，提供了数据传输、控制过程中的重要信息，下面我们一一来看其内部结构：

### 报头

`TCP协议`的前20字段被称为`TCP报头`，这部分包含了`16位源端口号`，`16位目的端口号`，`32位序号`，`32位确认序号`，`4位首部长度`（6位保留，猜测用于内存对齐），`6位标志位`，`16位窗口大小`，`16位校验和`，`16位紧急指针`，下面分别解释一下：

![image-20241022223419900](C:\Users\34955\AppData\Roaming\Typora\typora-user-images\image-20241022223419900.png)



- __16位源 / 目的端口号__：表示数据从哪个进程端口来，目的是哪个进程端口；
- __32位序号 / 32位确认序号__：可以认为是用于标明报文顺序，实现TCP协议的顺序性的信息，之后会进行详述；
- **4位首部长度：单位是4字节**，表示TCP报文长度，范围[0, 15]，表示的大小为[0, 60]
- **6位标志位**：
  - **URG (Urgent)**：
    - **功能**：指示紧急数据有效。
    - **作用**：当URG标志被设置为1时，紧急指针字段（Urgent Pointer）将指向紧急数据的结束位置。接收方在接收该数据时应优先处理这些数据。
  - **ACK (Acknowledgment)**：
    - **功能**：指示确认号字段有效。
    - **作用**：当ACK标志被设置为1时，确认号字段包含接收到的下一个字节的序号。此标志通常在TCP数据传输过程中始终被设置为1。
  - **PSH (Push)**：
    - **功能**：请求接收方尽快将数据传递给应用层。
    - **作用**：当PSH标志被设置为1时，接收方应立即将接收到的数据传递给应用程序，而不是等待缓冲区满。
  - **RST (Reset)**：
    - **功能**：重置连接。	
    - **作用**：当RST标志被设置为1时，表示连接出现错误或需要强制关闭。接收方会立即关闭连接，丢弃所有未处理的数据
  - **SYN (Synchronize)**：
    - **功能**：请求建立连接。
    - **作用**：在建立TCP连接的过程中，SYN标志用于初始化序号。当一方希望建立连接时，会发送带有SYN标志的包。
  - **FIN (Finish)**：
    - **功能**：请求关闭连接。
    - **作用**：当一方希望终止连接时，会发送带有FIN标志的包，表示发送方已经没有数据要发送。
- __16位窗口大小__：用于反应对端的可接受数据大小
- **16位校验和**：发送端填充，CRC校验。接收端校验不通过，则认为数据有问题。此处的检验和不光包含TCP首部，也
  包含TCP数据部分；
- **16位紧急指针**：表示哪些数据是紧急数据，指针指向紧急数据的起始位置；

综上，我们便简单的介绍了TCP报文中的报头部分，可以看到，这20字节维护了一些非常重要的数据，这也是TCP可以实现可靠性等特点的前提；

### 选项

在报头之后，还有0到40字节的选项，这是TCP可选的字段，关于选项的详细信息我会在之后的文章中详谈，这里就不作解释了。



## TCP状态

TCP在建立连接和断开连接时，会在报头的不同标志位设置对应属性，而且通信两端的TCP状态也会随之发生变化，下面我来介绍一下：

### TCP的三次握手

我们先来谈谈TCP的建立过程，而根据它的特性被总结为TCP的三次握手机制：

1. 首先客户端发起连接请求（注意，一定是客户端发起的连接请求），根据上面的标志位，可以查到当前标志位应该被设置为SYN，向服务端发起请求；
2. 服务端接收到连接请求（注意，在此之前，服务端一直处于LINSTEN状态，这表示一种监听状态，一旦有连接请求，服务端会立即执行对应操作），先对请求进行确认，随后会向客户也发送一个连接请求（注意，这里为了节省报文发送的数量，采取了捎带应答（后面会谈到），将ACK和SYN并作一起发送给客户端）；
3. 客户端在接收到了对应的连接请求后，也向服务端发送ACK确认报文，至此，TCP建立连接的三次握手完成；

以图片的形式呈现如下：（注意客户端和服务端的状态变化，以及标志位的设置）

![image-20241022231135116](C:\Users\34955\AppData\Roaming\Typora\typora-user-images\image-20241022231135116.png)

### TCP的四次挥手

TCP断开连接的方式和建立类似，不过采用的是四次挥手（两次请求，两次确认）的机制：

1. 首先，一方（这里是客户端还是服务端没有严格要求）发起断开请求（对应标志位为FIN）；
2. 当另一方接收到请求报文时，会向对端发送一个确认报文（ACK）；
3. 这时，接收到报文的一方也会向其对端发送断开请求（同样是FIN）；
4. 另一方接收报文并返回确认报文（ACK），至此，TCP四次挥手过程完成，TCP连接断开；

如下图（这里以客户端先发起为例）：

![image-20241022232637519](C:\Users\34955\AppData\Roaming\Typora\typora-user-images\image-20241022232637519.png)



